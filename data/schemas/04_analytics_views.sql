-- =====================================================
-- ANALYTICS SCHEMA VIEWS
-- =====================================================

USE SCHEMA RETAIL_DATALAKE.ANALYTICS;

-- =====================================================
-- SALES BY COUNTRY VIEW
-- =====================================================

CREATE OR REPLACE VIEW SALES_BY_COUNTRY AS
SELECT 
    t.COUNTRY,
    COUNT(DISTINCT t.INVOICE_NO) AS TOTAL_ORDERS,
    COUNT(DISTINCT t.CUSTOMER_ID) AS UNIQUE_CUSTOMERS,
    SUM(t.TOTAL_AMOUNT) AS TOTAL_REVENUE,
    AVG(t.TOTAL_AMOUNT) AS AVERAGE_ORDER_VALUE,
    SUM(t.QUANTITY) AS TOTAL_ITEMS_SOLD,
    MIN(t.INVOICE_DATE) AS FIRST_ORDER_DATE,
    MAX(t.INVOICE_DATE) AS LAST_ORDER_DATE,
    
    -- Calculate percentages
    ROUND(
        (SUM(t.TOTAL_AMOUNT) / SUM(SUM(t.TOTAL_AMOUNT)) OVER ()) * 100, 2
    ) AS REVENUE_PERCENTAGE,
    
    -- Customer metrics
    ROUND(AVG(t.TOTAL_AMOUNT), 2) AS AVG_TRANSACTION_VALUE,
    COUNT(*) AS TOTAL_TRANSACTIONS
    
FROM RETAIL_DATALAKE.PROCESSED_DATA.TRANSACTIONS t
WHERE t.TRANSACTION_TYPE = 'SALE'
GROUP BY t.COUNTRY
ORDER BY TOTAL_REVENUE DESC;

-- =====================================================
-- MONTHLY REVENUE TREND VIEW
-- =====================================================

CREATE OR REPLACE VIEW MONTHLY_REVENUE_TREND AS
SELECT 
    DATE_TRUNC('month', t.INVOICE_DATE) AS MONTH,
    t.COUNTRY,
    COUNT(DISTINCT t.INVOICE_NO) AS ORDERS,
    COUNT(DISTINCT t.CUSTOMER_ID) AS CUSTOMERS,
    SUM(t.TOTAL_AMOUNT) AS REVENUE,
    AVG(t.TOTAL_AMOUNT) AS AVG_ORDER_VALUE,
    SUM(t.QUANTITY) AS ITEMS_SOLD,
    
    -- Month-over-month growth
    LAG(SUM(t.TOTAL_AMOUNT)) OVER (
        PARTITION BY t.COUNTRY 
        ORDER BY DATE_TRUNC('month', t.INVOICE_DATE)
    ) AS PREV_MONTH_REVENUE,
    
    ROUND(
        ((SUM(t.TOTAL_AMOUNT) - LAG(SUM(t.TOTAL_AMOUNT)) OVER (
            PARTITION BY t.COUNTRY 
            ORDER BY DATE_TRUNC('month', t.INVOICE_DATE)
        )) / NULLIF(LAG(SUM(t.TOTAL_AMOUNT)) OVER (
            PARTITION BY t.COUNTRY 
            ORDER BY DATE_TRUNC('month', t.INVOICE_DATE)
        ), 0)) * 100, 2
    ) AS REVENUE_GROWTH_PCT
    
FROM RETAIL_DATALAKE.PROCESSED_DATA.TRANSACTIONS t
WHERE t.TRANSACTION_TYPE = 'SALE'
GROUP BY DATE_TRUNC('month', t.INVOICE_DATE), t.COUNTRY
ORDER BY MONTH DESC, REVENUE DESC;

-- =====================================================
-- TOP PRODUCTS VIEW
-- =====================================================

CREATE OR REPLACE VIEW TOP_PRODUCTS AS
SELECT 
    p.STOCK_CODE,
    p.DESCRIPTION,
    p.TOTAL_QUANTITY_SOLD,
    p.TOTAL_REVENUE,
    p.AVERAGE_UNIT_PRICE,
    p.UNIQUE_CUSTOMERS,
    
    -- Rankings
    RANK() OVER (ORDER BY p.TOTAL_REVENUE DESC) AS REVENUE_RANK,
    RANK() OVER (ORDER BY p.TOTAL_QUANTITY_SOLD DESC) AS QUANTITY_RANK,
    RANK() OVER (ORDER BY p.UNIQUE_CUSTOMERS DESC) AS CUSTOMER_RANK,
    
    -- Performance metrics
    ROUND(p.TOTAL_REVENUE / p.UNIQUE_CUSTOMERS, 2) AS REVENUE_PER_CUSTOMER,
    ROUND(p.TOTAL_QUANTITY_SOLD / p.UNIQUE_CUSTOMERS, 2) AS ITEMS_PER_CUSTOMER,
    
    -- Date information
    p.FIRST_SALE_DATE,
    p.LAST_SALE_DATE,
    DATEDIFF('day', p.FIRST_SALE_DATE, p.LAST_SALE_DATE) AS DAYS_ON_SALE
    
FROM RETAIL_DATALAKE.PROCESSED_DATA.PRODUCTS p
WHERE p.TOTAL_REVENUE > 0
ORDER BY p.TOTAL_REVENUE DESC;

-- =====================================================
-- CUSTOMER ANALYSIS VIEW
-- =====================================================

CREATE OR REPLACE VIEW CUSTOMER_ANALYSIS AS
SELECT 
    c.CUSTOMER_ID,
    c.COUNTRY,
    c.CUSTOMER_SEGMENT,
    c.TOTAL_ORDERS,
    c.TOTAL_ITEMS_PURCHASED,
    c.TOTAL_AMOUNT_SPENT,
    c.AVERAGE_ORDER_VALUE,
    c.FIRST_PURCHASE_DATE,
    c.LAST_PURCHASE_DATE,
    c.DAYS_SINCE_LAST_PURCHASE,
    
    -- Customer lifetime metrics
    DATEDIFF('day', c.FIRST_PURCHASE_DATE, c.LAST_PURCHASE_DATE) AS CUSTOMER_LIFETIME_DAYS,
    ROUND(c.TOTAL_AMOUNT_SPENT / NULLIF(c.TOTAL_ORDERS, 0), 2) AS CALCULATED_AOV,
    
    -- Purchase frequency
    CASE 
        WHEN DATEDIFF('day', c.FIRST_PURCHASE_DATE, c.LAST_PURCHASE_DATE) > 0
        THEN ROUND(c.TOTAL_ORDERS / DATEDIFF('day', c.FIRST_PURCHASE_DATE, c.LAST_PURCHASE_DATE) * 30, 2)
        ELSE NULL
    END AS ORDERS_PER_MONTH,
    
    -- Recency, Frequency, Monetary (RFM) scoring
    NTILE(5) OVER (ORDER BY c.DAYS_SINCE_LAST_PURCHASE ASC) AS RECENCY_SCORE,
    NTILE(5) OVER (ORDER BY c.TOTAL_ORDERS) AS FREQUENCY_SCORE,
    NTILE(5) OVER (ORDER BY c.TOTAL_AMOUNT_SPENT) AS MONETARY_SCORE
    
FROM RETAIL_DATALAKE.PROCESSED_DATA.CUSTOMERS c
WHERE c.TOTAL_ORDERS > 0
ORDER BY c.TOTAL_AMOUNT_SPENT DESC;

-- =====================================================
-- DAILY SALES SUMMARY VIEW
-- =====================================================

CREATE OR REPLACE VIEW DAILY_SALES_SUMMARY AS
SELECT 
    DATE(t.INVOICE_DATE) AS SALE_DATE,
    DAYNAME(t.INVOICE_DATE) AS DAY_OF_WEEK,
    COUNT(DISTINCT t.INVOICE_NO) AS TOTAL_ORDERS,
    COUNT(DISTINCT t.CUSTOMER_ID) AS UNIQUE_CUSTOMERS,
    COUNT(*) AS TOTAL_TRANSACTIONS,
    SUM(t.TOTAL_AMOUNT) AS TOTAL_REVENUE,
    AVG(t.TOTAL_AMOUNT) AS AVG_TRANSACTION_VALUE,
    SUM(t.QUANTITY) AS TOTAL_ITEMS_SOLD,
    
    -- Running totals
    SUM(SUM(t.TOTAL_AMOUNT)) OVER (
        ORDER BY DATE(t.INVOICE_DATE) 
        ROWS UNBOUNDED PRECEDING
    ) AS CUMULATIVE_REVENUE,
    
    -- Day-over-day comparison
    LAG(SUM(t.TOTAL_AMOUNT)) OVER (ORDER BY DATE(t.INVOICE_DATE)) AS PREV_DAY_REVENUE,
    ROUND(
        ((SUM(t.TOTAL_AMOUNT) - LAG(SUM(t.TOTAL_AMOUNT)) OVER (ORDER BY DATE(t.INVOICE_DATE))) 
         / NULLIF(LAG(SUM(t.TOTAL_AMOUNT)) OVER (ORDER BY DATE(t.INVOICE_DATE)), 0)) * 100, 2
    ) AS DAILY_GROWTH_PCT
    
FROM RETAIL_DATALAKE.PROCESSED_DATA.TRANSACTIONS t
WHERE t.TRANSACTION_TYPE = 'SALE'
GROUP BY DATE(t.INVOICE_DATE), DAYNAME(t.INVOICE_DATE)
ORDER BY SALE_DATE DESC;

-- =====================================================
-- RETURNS ANALYSIS VIEW
-- =====================================================

CREATE OR REPLACE VIEW RETURNS_ANALYSIS AS
SELECT 
    t.COUNTRY,
    t.STOCK_CODE,
    p.DESCRIPTION,
    COUNT(*) AS RETURN_TRANSACTIONS,
    SUM(ABS(t.QUANTITY)) AS TOTAL_RETURNED_QUANTITY,
    SUM(ABS(t.TOTAL_AMOUNT)) AS TOTAL_RETURN_VALUE,
    AVG(ABS(t.TOTAL_AMOUNT)) AS AVG_RETURN_VALUE,
    
    -- Return rates (need to join with sales data)
    COUNT(DISTINCT t.CUSTOMER_ID) AS CUSTOMERS_WITH_RETURNS,
    
    DATE(MIN(t.INVOICE_DATE)) AS FIRST_RETURN_DATE,
    DATE(MAX(t.INVOICE_DATE)) AS LAST_RETURN_DATE
    
FROM RETAIL_DATALAKE.PROCESSED_DATA.TRANSACTIONS t
JOIN RETAIL_DATALAKE.PROCESSED_DATA.PRODUCTS p ON t.STOCK_CODE = p.STOCK_CODE
WHERE t.TRANSACTION_TYPE = 'RETURN'
GROUP BY t.COUNTRY, t.STOCK_CODE, p.DESCRIPTION
ORDER BY TOTAL_RETURN_VALUE DESC;
